# Checksum Checker (Riprap) Documentation

Documentation generated on Jul 27th, 2021 for the UTSC Library Digital Scholarship Unit

## Riprap Microservice

Extended off [Mark Jordan's Riprap Microservice](https://github.com/mjordan/riprap)

### Configuration YML file
New setting fields added:
- `verify`: this field should be a Boolean value or empty; used to determine whether or not to compare the checksums against the FITS checksum value of a file
- `plugins.verify`: the name of the plugin used to compare the checksums against the FITS checksum value of a file

### Abstract Class: AbstractVerifyChecksumPlugin.php
Abstract class defined with an implemented constructor and an abstract method of `execute()` to be implemented by the child class that extends it.
  
Fields of the class
- _settings_: The configuration data from the settings file
- _logger_: The Monolog logger from the main Console command.
- _verify_: Boolean flag that is set to the value from the config file  
  
| Methods | Description | Parameters | Return Value |
| ----------- | ----------- | ----------- | ----------- |
| `__construct()`  | Constructor of the class, takes in the current settings config (from the YML file) and a logger for messaging printing if needed | <ul> <li>`settings`: The configuration data from the settings file </li> <li>`logger`: The Monolog logger from the main Console command</li> </ul>| An instance of the abstract class |
| `execute()`| Abstract method that verifies the checksum generated by the Drupal algorithm against the FITS checksum | <ul> <li>`resource_id`: The resource ID of the file </li> <li>`comparison_checksum`: The checksum value that Riprap is using</li> </ul>|  True if it is equal, False if mismatch or error |

### List of new plugins

| Plugin Class | Extends/Parent Class | Description |
| ----------- | ----------- | ----------- |
|` PluginFetchFileListFromDrupalView` | `AbstractFetchResourceListPlugin` | Gets the list of file resources from Drupal to perfom the fixity checks ("fetchresourcelist" plugins)| 

### CheckFixityCommand.php

New code block added in order to do an extra check to ensure that the Drupal native Checksum is equivalent to the FITS one. The verify Plugin only runs if the field `verify` in the Config file is set to True.

    if(isset($this->settings['verify']) && $this->settings['verify']){
        // Execute the verify plugin.
        $this->verifyPlugin = $this->settings['plugins.verify'];
        $verify_plugin_name = 'App\Plugin\\' . $this->verifyPlugin;
        $verify_plugin = new $verify_plugin_name($this->settings, $this->logger);
        $fits_equal = $verify_plugin->execute($resource_record->resource_id, $current_digest_value);

        if(!$fits_equal){
            $outcome = 'fail';
            $event_detail = 'checksum does not match FITS checksum';
        } else {
            $outcome = 'success';
            $event_detail = 'checksum matches FITS checksum';
            }
     }


## Islandora Riprap Module

Extended off [Mark Jordan's Islandora Riprap Module](https://github.com/mjordan/islandora_riprap)

### New HTML Twig Files

*islandora-riprap-file-events.html.twig*  
HTML twig file to display Riprap events for each file (i.e. `/file/{fid}/riprap`)  
  
*islandora-riprap-file-summary.html.twig*  
HTML twig file to display the fixity auditing column in the admin file page (i.e. `/admin/content/files`)


### List of new classes

| Class | Extends/Parent Class | Type | Description |
| ----------- | ----------- | ----------- | ----------- |
| `IslandoraRiprapFileEventsController` | `ControllerBase` | Controller | Controller for the Islandora Riprap module customized for file ID|
| `RiprapFileResults` | `FieldPluginBase` | Field Plugin | Field plugin that renders data for File from Riprap | 
| `RiprapFiles` | `Riprap` | Utility for interacting with the Riprap fixity microservice | Extends the native Riprap class and overrides the `getFileUuid()` and `getLocalUrl()` methods from the parent class | 

### islandora_riprap.module
Extra coded added to apply JS for the file view (i.e. `/admin/content/file`)  
  
    if (
        count($path_args) >= 3 &&
        ($path_args[2] == "media" || $path_args[2] == "files")
        ) {
            $attachments["#attached"]["library"][] =
            "islandora_riprap/islandora_riprap_media";
        }


### islandora_riprap.routing.yml  
New routing path for the Riprap event page for each file
  
    islandora_riprap.file_events:
        path: "/file/{file}/riprap"
         defaults:
            _controller: '\Drupal\islandora_riprap\Controller\IslandoraRiprapFileEventsController::main'
            _title: "Fixity Events (File)"
        requirements:
            _permission: "manage file"
        file: \d+


### islandora_riprap.views.inc
New field added to allow the *fixity auditing* field to show up in the table  

    $data['file_managed']['riprap_results'] = [
        'title' => t('Fixity auditing'),
        'help' => t('Show results from the Riprap fixity auditing microservice.'),
        'field' => [
        'id' => 'riprap_file_results',
        ],
    ];

### islandora_riprap.services.yml
New service `islandora_riprap.riprap_files` defined for the interaction of files and the Riprap fixity microservice  
  
    islandora_riprap.riprap_files:
        class: Drupal\islandora_riprap\Riprap\RiprapFiles
